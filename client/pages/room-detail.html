<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Room Detail - Chess Online P2P</title>
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>‚ôüÔ∏è Chi ti·∫øt ph√≤ng</h1>
      <div class="user-info">
        <span id="player-name">Player</span>
        <button id="leave-room-btn" class="btn btn-danger btn-sm">R·ªùi ph√≤ng</button>
      </div>
    </div>

    <div class="room-detail-container">
      <div class="room-info-section">
        <h2 id="room-title">Room Name</h2>
        <p>M√£ ph√≤ng: <strong id="room-code">XXXXXX</strong></p>
        <p>Ch·∫ø ƒë·ªô: <span id="room-mode">Normal</span></p>
        <p id="time-info">Th·ªùi gian: 60s/n∆∞·ªõc</p>
      </div>

      <div class="players-section">
        <div class="player-slot">
          <h3>Host</h3>
          <div class="player-card" id="host-card">
            <div class="player-avatar">üë§</div>
            <div class="player-info">
              <div class="player-name" id="host-name">ƒêang ch·ªù...</div>
              <div class="player-status" id="host-status">
                <span class="status-indicator"></span>
                <span>Ch∆∞a s·∫µn s√†ng</span>
              </div>
            </div>
          </div>
        </div>

        <div class="vs-divider">VS</div>

        <div class="player-slot">
          <h3>Guest</h3>
          <div class="player-card" id="guest-card">
            <div class="player-avatar">üë§</div>
            <div class="player-info">
              <div class="player-name" id="guest-name">ƒêang ch·ªù...</div>
              <div class="player-status" id="guest-status">
                <span class="status-indicator"></span>
                <span>Ch∆∞a s·∫µn s√†ng</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="room-actions">
        <button id="ready-btn" class="btn btn-success btn-large">S·∫µn s√†ng</button>
        <button id="start-game-btn" class="btn btn-primary btn-large" style="display: none;" disabled>B·∫Øt ƒë·∫ßu game</button>
      </div>

      <div class="online-players-section">
        <h3>Ng∆∞·ªùi ch∆°i tr·ª±c tuy·∫øn</h3>
        <div id="online-players-list" class="online-players-list">
          <p class="loading">ƒêang t·∫£i...</p>
        </div>
      </div>
    </div>
  </div>

  <script src="/js/websocket.js"></script>
  <script src="/js/room.js"></script>
  <script src="/js/main.js"></script>
  <script>
    const player = getCurrentPlayer();
    if (!player) {
      window.location.href = '/login';
    }

    document.getElementById('player-name').textContent = player.displayname || player.username;

    // Get room ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const roomId = urlParams.get('roomId');

    if (!roomId) {
      window.location.href = '/custom-match';
    }

    initWebSocket(player.player_id);
    loadRoomDetails(roomId);
    loadOnlinePlayers();

    let isReady = false;
    document.getElementById('ready-btn').addEventListener('click', () => {
      isReady = !isReady;
      toggleReady(roomId, isReady);
    });

    document.getElementById('start-game-btn').addEventListener('click', () => {
      startGameFromRoom(roomId);
    });

    document.getElementById('leave-room-btn').addEventListener('click', async () => {
      leaveRoom(roomId);
      window.location.href = '/custom-match';
    });

    if (window.ws) {
      const originalOnMessage = window.ws.onmessage;
      window.ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        
        if (data.type === 'room_updated' && data.room.id == roomId) {
          updateRoomUI(data.room);
        }
        
        if (data.type === 'game_started' && data.roomId == roomId) {
          window.location.href = `/game?gameId=${data.gameId}`;
        }

        if (data.type === 'room_invitation') {
          if (confirm(`B·∫°n ƒë∆∞·ª£c m·ªùi v√†o ph√≤ng. Tham gia?`)) {
            leaveRoom(roomId);
            joinRoomWithPassword(data.roomId, data.roomPassword);
          }
        }

        if (data.type === 'update_UI' && data.roomId == roomId) {
          loadRoomDetails(roomId);
        }
        
        if (data.type == 'room_join_request' && data.roomId == roomId) {
          const approve = confirm(`${data.requesterName} mu·ªën tham gia ph√≤ng c·ªßa b·∫°n. Ch·∫•p nh·∫≠n?`);
          if (approve) {
            approveJoinRequest(roomId, data.requesterId);
          } else {
            rejectJoinRequest(roomId, data.requesterId);
          }
        }
        if (originalOnMessage) originalOnMessage(event);
      };
    }

    function updateRoomUI(room) {
      // Update host
      if (room.host_player_id) {
        const hostStatus = document.getElementById('host-status');
        hostStatus.querySelector('span:last-child').textContent = 
          room.host_ready ? '‚úì S·∫µn s√†ng' : 'Ch∆∞a s·∫µn s√†ng';
        hostStatus.classList.toggle('ready', room.host_ready);
      }

      // Update guest
      if (room.guest_player_id) {
        const guestStatus = document.getElementById('guest-status');
        guestStatus.querySelector('span:last-child').textContent = 
          room.guest_ready ? '‚úì S·∫µn s√†ng' : 'Ch∆∞a s·∫µn s√†ng';
        guestStatus.classList.toggle('ready', room.guest_ready);
      }

      // Update start button
      if (room.host_player_id === player.player_id) {
        const startBtn = document.getElementById('start-game-btn');
        startBtn.style.display = 'block';
        startBtn.disabled = !(room.host_ready && room.guest_ready && room.guest_player_id);
      }
    }
  </script>
</body>
</html>
